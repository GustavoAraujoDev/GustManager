<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Funcion√°rios | GustManager </title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<!-- Material UI -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
   :root {
  /* Tema Claro */
  --bg-light: #FCF8F3;
  --text-light: #1F3A4A;
  --card-light: #FFFFFF;

  /* Tema Escuro */
  --bg-dark: #111827;
  --text-dark: #F9FAFB;
  --card-dark: #1F2937;

  /* Cores principais */
  --primary-color: #028090;
  --primary-hover: #026873;
  --success-color: #10B981;
  --warning-color: #F59E0B;
  --danger-color: #EF4444;
  --border-dark: #374151;
  --border-light: #E5E7EB;
}

/* === MODO CLARO === */
body {
  font-family: 'Roboto', sans-serif;
  background: var(--bg-light);
  color: var(--text-light);
  padding: 10px;
  transition: background 0.3s, color 0.3s;
}

.dark-mode body {
  background-color: var(--bg-dark);
  color: var(--text-dark);
}

.container {
  max-width: 900px;
  margin: auto;
  background: var(--card-light);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

.table-striped tbody tr:nth-of-type(odd) {
  background-color: rgba(0, 0, 0, 0.03);
}

/* === BOT√ïES GERAIS === */

/* Tipos de bot√µes */
.btn-primary {
  background-color: var(--primary-color);
  color: #fff;
  border-color: var(--primary-color);
}

.btn-primary:hover {
  background-color: var(--primary-hover);
  border-color: var(--primary-hover);
}

.btn-primary:focus,
.btn-primary:active {
  box-shadow: 0 0 0 0.2rem rgba(2, 128, 144, 0.4);
  outline: none;
}

.btn-outline-primary {
  background-color: transparent;
  color: var(--primary-color);
  border-color: var(--primary-color);
}

.btn-outline-primary:hover {
  background-color: var(--primary-color);
  color: #fff;
}

.btn-success {
  background-color: var(--success-color);
  color: #fff;
}

.btn-success:hover {
  background-color: #0e9f6e;
}

.btn-danger {
  background-color: var(--danger-color);
  color: #fff;
}

.btn-danger:hover {
  background-color: #dc2626;
}

.btn-warning {
  background-color: var(--warning-color);
  color: var(--text-light);
}

.btn-warning:hover {
  background-color: #d97706;
}

.btn-outline-info {
  color: #0dcaf0;
  border-color: #0dcaf0;
}

 .btn-outline-info:hover {
  background-color: #0dcaf0;
  color: #fff;
}

.btn-outline-warning {
  color: var(--warning-color);
  border-color: var(--warning-color);
}

 .btn-outline-warning:hover {
  background-color: var(--warning-color);
  color: var(--text-light);
}

.btn-outline-danger {
  color: var(--danger-color);
  border-color: var(--danger-color);
}

 .btn-outline-danger:hover {
  background-color: var(--danger-color);
  color: #fff;
}

/* === MODO ESCURO === */
.dark-mode {
  background-color: var(--bg-dark);
  color: var(--text-dark);
}

.dark-mode .container {
  background-color: var(--card-dark);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

.dark-mode .table {
  color: var(--text-dark);
  background-color: transparent;
  border-collapse: separate;
  border-spacing: 0 0.5rem;
}

.dark-mode .table th {
  background-color: #2a2a2a;
  color: var(--text-dark);
  font-weight: 600;
  border: none;
}

.dark-mode .table-striped tbody tr {
  background-color: #1c1c1c;
  border-radius: 8px;
  overflow: hidden;
}

.dark-mode .table-hover tbody tr:hover {
  background-color: #2d2d2d;
}

.dark-mode .table-striped tbody tr:nth-of-type(odd) {
  background-color: rgba(255, 255, 255, 0.03);
}

.dark-mode .table-dark {
  background-color: #2c2c2c;
}

/* Navbar */
.dark-mode .navbar {
  background-color: var(--card-dark) !important;
  border-bottom: 1px solid var(--border-dark);
}

/* Bot√µes no modo escuro */
.dark-mode .btn {
  color: var(--text-dark);
}

.dark-mode .btn-light {
  background-color: #2e2e2e;
  color: var(--text-dark);
  border: 1px solid var(--border-dark);
}

.dark-mode .btn-warning {
  background-color: var(--warning-color);
  color: var(--text-light);
  border: none;
}

.dark-mode .btn-secondary {
  background-color: #3c3c3c;
  color: var(--text-dark);
  border: 1px solid var(--border-dark);
}

/* Formul√°rios no modo escuro */
.dark-mode input,
.dark-mode select,
.dark-mode textarea {
  background-color: #2a2a2a;
  color: var(--text-dark);
  border: 1px solid var(--border-dark);
  border-radius: 6px;
}

.dark-mode input::placeholder,
.dark-mode textarea::placeholder {
  color: #aaaaaa;
}

.dark-mode .form-control:focus {
  background-color: #2a2a2a;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 0.2rem rgba(2, 128, 144, 0.25);
}

/* Modais */
.dark-mode .modal-content {
  background-color: var(--card-dark);
  color: var(--text-dark);
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.6);
}

.dark-mode .modal-header,
.dark-mode .modal-footer {
  border-color: var(--border-dark);
}

/* Transi√ß√µes suaves */
.dark-mode,
.dark-mode .container,
.dark-mode .table,
.dark-mode .navbar,
.dark-mode .btn,
.dark-mode input,
.dark-mode select,
.dark-mode textarea,
.dark-mode .modal-content {
  transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease, box-shadow 0.3s ease;
}

/* =================== TOGGLE DE TEMA =================== */
.theme-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
}

.theme-toggle .btn {
  border-radius: 50%;
  width: 48px;
  height: 48px;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: var(--primary-color);
  color: #fff;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  transition: background-color 0.3s;
}

.dark-mode nav{
background-color: var(--bg-dark);
color: var(--text-dark)
}

nav{
background-color: var(--bg-light);
color: var(--text-light);
}

.dark-mode td {
  background-color: black;
  color: #F9FAFB;
  border: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

.dark-mode th {
  background-color: black;
  color: #F9FAFB;
  border: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

    </style>
</head>
<body>

<div class="theme-toggle">
  <button class="btn" id="btnToggleTheme">
    <span class="material-icons" id="iconeTema">dark_mode</span>
  </button>
</div>

<!-- Navbar responsiva -->
<nav class="navbar ">
  <div class="container-fluid d-flex flex-column flex-lg-row justify-content-between align-items-center py-2 text-center text-lg-start">

    <!-- Bot√£o Voltar -->
    <button class="btn btn-outline-dark mb-2 mb-lg-0 d-flex align-items-center" onclick="window.history.back()">
      <i class="fas fa-arrow-left me-2"></i> Voltar
    </button>

    <!-- T√≠tulo Central -->
    <span class="navbar-brand fw-semibold h5 mb-2 mb-lg-0">
      Gest√£o de Funcion√°rios
    </span>

    <!-- Espa√ßo reservado para futuro bot√£o/menu ou apenas manter alinhamento -->
    <div style="width: 90px;"></div>

  </div>
</nav>

<div class="container">
    <h2 class="mb-4">Gest√£o de Funcion√°rios</h2>

<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

 <button class="btn btn-primary d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#addFuncionarioModal">
  <span class="material-symbols-outlined">person_add</span>
  Adicionar Funcion√°rio
</button>
    <!-- Filtro e busca -->
    <input type="text" id="search" class="form-control mt-3" placeholder="üîç Buscar funcion√°rio...">

    <!-- Tabela de Funcion√°rios -->
    <div class="table-responsive mt-4">
        <table class="table table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Senha</th>
                    <th>Cargo</th>
                    <th>Sal√°rio</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="funcionarios-list">
                <!-- Funcion√°rios carregados do Firebase -->
            </tbody>
        </table>
    </div>
</div>


<!-- MODAL: Adicionar Funcion√°rio -->
<div class="modal fade" id="addFuncionarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Adicionar Funcion√°rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="funcionarioForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Nome Completo</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="material-icons">person</i></span>
                                <input type="text" id="nome" class="form-control" placeholder="Digite o nome" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="material-icons">person</i></span>
                                <input type="text" id="email" class="form-control" placeholder="Digite o email" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Senha </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="material-icons">person</i></span>
                                <input type="password" id="senha" class="form-control" placeholder="Digite a senha" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Cargo</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="material-icons">work</i></span>
                                <input type="text" id="cargo" class="form-control" placeholder="Ex: Gar√ßom, Churrasqueiro..." required>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Sal√°rio (R$)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="material-icons">attach_money</i></span>
                                <input type="text" id="salario" class="form-control" placeholder="Informe o sal√°rio" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Telefone</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="material-icons">phone</i></span>
                                <input type="text" id="telefone" class="form-control" placeholder="(XX) XXXXX-XXXX" required>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Data de Admiss√£o</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="material-icons">date_range</i></span>
                                <input type="date" id="dataAdmissao" class="form-control" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Turno</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="material-icons">access_time</i></span>
                                <select id="turno" class="form-control" required>
                                    <option value="">Selecione</option>
                                    <option value="Diurno">Diurno</option>
                                    <option value="Noturno">Noturno</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer mt-4">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Realizar Pagamento -->
<div class="modal fade" id="pagamentoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Realizar Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="pagamentoForm">
                    <inputs type="hidden" id="funcionarioId"> <!-- Armazena o ID do funcion√°rio -->

                    <div class="mb-3">
                        <label class="form-label">Funcion√°rio</label>
                        <select id="funcionarioSelect" class="form-select" required></select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tipo de Lan√ßamento</label>
                        <select id="tipoLancamento" class="form-select" required>
                            <option value="">Selecione</option>
                            <option value="Pagamento">Pagamento</option>
                            <option value="Vale">Vale</option>
                            <option value="Ajuste">Ajuste</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Valor (R$)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="material-icons">attach_money</i></span>
                            <input type="number" id="valorLancamento" class="form-control" placeholder="Informe o valor" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descri√ß√£o</label>
                        <textarea id="descricaoLancamento" class="form-control" rows="2" placeholder="Ex: Adiantamento de sal√°rio, pagamento mensal, etc." required></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Confirmar Pagamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Container para mensagens de Toast -->
<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

<!-- MODAL: Hist√≥rico de Pagamentos -->
<div class="modal fade" id="historicoModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-history"></i> Hist√≥rico de Pagamentos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Informa√ß√µes do Funcion√°rio -->
                <div class="d-flex align-items-center mb-3 p-3 bg-light rounded shadow-sm">
                    <i class="fas fa-user-circle fa-3x text-primary me-3"></i>
                    <div>
                        <h5 id="nomeFuncionario" class="mb-0"></h5>
                        <small id="cargoFuncionario" class="text-muted"></small>
                    </div>
                </div>

                <!-- Tabela de Hist√≥rico -->
                <div class="table-responsive">
                    <table class="table table-hover table-bordered align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Descri√ß√£o</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="historicoContent">
                            <tr>
                                <td colspan="4" class="text-center text-muted">üîç Selecione um funcion√°rio para visualizar o hist√≥rico.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal"><i class="fas fa-times"></i> Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o para Remover Produto -->
<div class="modal fade" id="confirmacaoRemocaoProduto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill text-warning"></i> Excluir Produto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p id="confirmacaoTexto">Tem certeza que deseja remover este produto?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarRemoverProduto">
                    <i class="bi bi-trash-fill"></i> Remover
                </button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { getDatabase, ref, push, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHVTY81_-m3ct_Yx7B9L4JyMxCFSH0isg",
            authDomain: "pagina-de-avaliacao.firebaseapp.com",
            databaseURL: "https://pagina-de-avaliacao-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pagina-de-avaliacao",
            storageBucket: "pagina-de-avaliacao.firebasestorage.app",
            messagingSenderId: "533323669910",
            appId: "1:533323669910:web:4442513a47be857f097db7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

function carregarFuncionarios() {
    const funcionariosRef = ref(db, 'funcionarios');
    onValue(funcionariosRef, (snapshot) => {
        if (!snapshot.exists()) return;

        const tbody = document.getElementById("funcionarios-list");
        tbody.innerHTML = "";

        snapshot.forEach(childSnapshot => {
            const func = childSnapshot.val();
            func.id = childSnapshot.key;
            
            let tr = document.createElement("tr");

            tr.innerHTML = `
        <td class="align-middle fw-semibold">${func.nome}</td>
        <td class="align-middle">${func.email}</td>
        <td class="align-middle">${func.senha}</td>
        <td class="align-middle">${func.cargo}</td>
        <td class="align-middle">R$ ${parseFloat(func.salario).toFixed(2)}</td>
        <td class="text-center align-middle">
            <button class="btn btn-outline-info btn-sm me-1" title="Ver Hist√≥rico"
                onclick="abrirModalHistorico('${func.id}', '${func.nome}')">
               <span class="material-symbols-outlined">history</span>
            </button>
            <button class="btn btn-outline-warning btn-sm me-1" title="Adicionar Pagamento"
                onclick="abrirModalPagamento('${func.id}', '${func.nome}')">
                <span class="material-symbols-outlined">payments</span>
            </button>
            <button class="btn btn-outline-danger btn-sm" title="Remover Funcion√°rio"
                onclick="removerProduto('${func.id}', '${func.nome}')">
              <span class="material-symbols-outlined">delete</span>
            </button>
        </td>
    `;

            tbody.appendChild(tr);
        });
    });
};

    document.getElementById("funcionarioForm").addEventListener("submit", async function(event) {
  event.preventDefault();

  const form = event.target;
  const btnSubmit = form.querySelector("button[type='submit']");
  btnSubmit.disabled = true;
  btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Salvando...';

  // Captura e trim dos dados
  let nome = form.nome.value.trim();
  let email = form.email.value.trim();
  let senha = form.senha.value.trim();
  let cargo = form.cargo.value.trim().charAt(0).toUpperCase() +                    form.cargo.value.trim().slice(1).toLowerCase();
  let salario = form.salario.value.trim().replace("R$", "").replace(",", ".");
  let telefone = form.telefone.value.trim().replace(/\D/g, '');
  let data = new Date(form.dataAdmissao.value).toLocaleDateString("pt-BR"); // <-- Padroniza para dd/mm/aaaa
  let turno = form.turno.value;
  
  // Valida√ß√µes
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const telefoneRegex = /^\d{10,11}$/;

  if (!nome || !email || !senha || !cargo || !salario || !telefone || !dataAdmissao || !turno) {
    showToast("Preencha todos os campos!", "danger");
    resetBtn();
    return;
  }

  if (!emailRegex.test(email)) {
    showToast("Email inv√°lido!", "danger");
    resetBtn();
    return;
  }

  if (!telefoneRegex.test(telefone)) {
    showToast("Telefone deve conter apenas n√∫meros (10 ou 11 d√≠gitos)", "danger");
    resetBtn();
    return;
  }

  if (isNaN(parseFloat(salario)) || parseFloat(salario) <= 0) {
    showToast("Sal√°rio inv√°lido!", "danger");
    resetBtn();
    return;
  }

  if (senha.length < 6) {
    showToast("A senha deve ter no m√≠nimo 6 caracteres!", "danger");
    resetBtn();
    return;
  }

  // Verifica duplicidade de email
  try {
    const funcionariosSnapshot = await get(ref(db, 'funcionarios'));
    let emailJaExiste = false;

    funcionariosSnapshot.forEach(child => {
      if (child.val().email === email) {
        emailJaExiste = true;
      }
    });

    if (emailJaExiste) {
      showToast("Esse e-mail j√° est√° cadastrado!", "danger");
      resetBtn();
      return;
    }


    // Salva no banco
    const funcionariosRef = ref(db, 'funcionarios');
    const novoFuncionario = push(funcionariosRef);

    await set(novoFuncionario, {
      nome,
      email,
      senha,
      cargo,
      salario: parseFloat(salario),
      telefone,
      data,
      turno,
    });

    form.reset();
    showToast("Funcion√°rio cadastrado com sucesso!", "success");

  } catch (error) {
    console.error("Erro ao salvar:", error);
    showToast("Erro ao salvar funcion√°rio!" + error, "danger");
    showToast(senhaCriptografada, "danger");
  } finally {
    resetBtn();
  }

  function resetBtn() {
    btnSubmit.disabled = false;
    btnSubmit.innerHTML = "Salvar";
  }
});

// Fun√ß√£o para exibir um toast estilizado
function showToast(message, type) {
    const toastContainer = document.getElementById("toastContainer");
    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${type} border-0 show`;
    toast.setAttribute("role", "alert");
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

    

// Fun√ß√£o para abrir o modal de pagamento com os dados do funcion√°rio
window.abrirModalPagamento = function (funcionarioId, nome) {
    const modalElement = document.getElementById("pagamentoModal");

    if (!modalElement) {
        alert("Erro: Modal de pagamento n√£o encontrado!");
        return;
    }

    document.getElementById("funcionarioId").value = funcionarioId;
    document.getElementById("funcionarioSelect").value = nome;

    try {
        const pagamentoModal = new bootstrap.Modal(modalElement);
        pagamentoModal.show();
    } catch (error) {
        console.error("Erro ao abrir o modal:", error);
    }
};

// Evento de submiss√£o do formul√°rio de pagamento
document.getElementById("pagamentoForm").addEventListener("submit", async function(event) {
    event.preventDefault();

    const btnSubmit = event.submitter;
    btnSubmit.disabled = true;
    btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processando...';

    let funcionarioId = document.getElementById("funcionarioId").value;
    let tipo = document.getElementById("tipoLancamento").value;
    let valor = document.getElementById("valorLancamento").value;
    let descricao = document.getElementById("descricaoLancamento").value;
    let data = new Date().toLocaleDateString("pt-BR"); // <-- Apenas data, sem hora

    if (!funcionarioId || !tipo || !valor || !descricao) {
        showToast("Preencha todos os campos!", "danger");
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = "Confirmar Pagamento";
        return;
    }

    try {
        const historicoRef = ref(db, `funcionarios/${funcionarioId}/historico`);
        const novoRegistro = push(historicoRef);

        await set(novoRegistro, {
            tipo,
            valor,
            descricao,
            data
        });

        showToast("Pagamento registrado com sucesso!", "success");
        document.getElementById("pagamentoForm").reset();
    } catch (error) {
        console.error("Erro ao salvar pagamento:", error);
        showToast("Erro ao registrar pagamento!", "danger");
    } finally {
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = "Confirmar Pagamento";
    }
});

// Fun√ß√£o para abrir o modal de hist√≥rico e carregar os pagamentos do funcion√°rio
window.abrirModalHistorico = function (funcionarioId, nome) {
    const modalElement = document.getElementById("historicoModal");
    const historicoContent = document.getElementById("historicoContent");

    // Exibe um carregamento inicial
    historicoContent.innerHTML = `<p class="text-center">‚è≥ Carregando hist√≥rico de <strong>${nome}</strong>...</p>`;

    const historicoRef = ref(db, `funcionarios/${funcionarioId}/historico`);

    onValue(historicoRef, (snapshot) => {
        if (!snapshot.exists()) {
            historicoContent.innerHTML = `<p class="text-center text-muted">üö´ Nenhum pagamento registrado para <strong>${nome}</strong>.</p>`;
            return;
        }

        let table = `
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Descri√ß√£o</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody>
        `;

        snapshot.forEach(childSnapshot => {
            const pagamento = childSnapshot.val();
            table += `
                <tr>
                    <td>${pagamento.tipo}</td>
                    <td>R$ ${parseFloat(pagamento.valor).toFixed(2)}</td>
                    <td>${pagamento.descricao}</td>
                    <td>${pagamento.data}</td>
                </tr>
            `;
        });

        table += `</tbody></table>`;
        historicoContent.innerHTML = table;
    });

    // Abrir modal
    const historicoModal = new bootstrap.Modal(modalElement);
    historicoModal.show();
};

window.removerProduto = function (produtoId, produtoNome) {
    // Atualiza o texto do modal com o nome do produto
    document.getElementById("confirmacaoTexto").innerText = `Tem certeza que deseja remover o Funcionario "${produtoNome}"?`;

    // Define a a√ß√£o do bot√£o de confirma√ß√£o
    document.getElementById("btnConfirmarRemoverProduto").onclick = function () {
        const produtoRef = ref(db, `funcionarios/${produtoId}`);

        remove(produtoRef)
            .then(() => {
           showToast("funcionario excluido com sucesso!", "success");
                new bootstrap.Modal(document.getElementById("confirmacaoRemocaoProduto")).hide();
            })
            .catch(error => console.error("Erro ao remover produto:", error));
    };

    // Exibe o modal de confirma√ß√£o
    new bootstrap.Modal(document.getElementById("confirmacaoRemocaoProduto")).show();
};
    

  // M√°scara para pre√ßos (formato R$ XX,XX)
    document.getElementById("salario").addEventListener("input", formatarPreco);
    document.getElementById("valorLancamento").addEventListener("input", formatarPreco);

    function formatarPreco(event) {
        let value = event.target.value.replace(/\D/g, ""); // Remove tudo que n√£o for n√∫mero
        value = (value / 100).toFixed(2).replace(".", ","); // Converte para decimal com 2 casas
        event.target.value = "R$ " + value;
    };

function verificarPermissao(bloqueados = []) {
  const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));

  if (!usuario) {
    alert("Voc√™ precisa estar logado.");
    window.location.href = "index.html";
    return false;
  }

  if (bloqueados.includes(usuario.cargo)) {
    alert("Acesso negado para seu cargo (" + usuario.cargo + ").");
    window.location.href = "dashboard.html";
    return false;
  }

  return true;
};

const toggleBtn = document.getElementById('btnToggleTheme');
  const iconeTema = document.getElementById('iconeTema');

  function aplicarTema() {
    const darkModeAtivo = localStorage.getItem('darkMode') === 'true';

    if (darkModeAtivo) {
      document.documentElement.classList.add('dark-mode');
      iconeTema.textContent = "light_mode";
    } else {
      document.documentElement.classList.remove('dark-mode');
      iconeTema.textContent = "dark_mode";
    }
  };

  toggleBtn.addEventListener('click', () => {
    const darkModeAtivo = document.documentElement.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', darkModeAtivo);
    iconeTema.textContent = darkModeAtivo ? "light_mode" : "dark_mode";
  });

aplicarTema();
verificarPermissao(["Atendente", "Gar√ßom", "Churrasqueiro", "Caixa"]);
carregarFuncionarios();
</script>

</body>
</html>